# Scheduled Invoice Generation

## Overview

This document describes the automated invoice generation system that runs daily at 00:00 WIB (Western Indonesian Time) to generate invoices for all active services that are due for billing.

## Requirements

**Requirement 3.1**: Laravel Scheduler berjalan setiap hari pada pukul 00:00 WIB, generate invoice untuk semua layanan aktif yang jatuh tempo billing.

## Components

### 1. GenerateInvoicesJob

**Location**: `app/Jobs/GenerateInvoicesJob.php`

This job is responsible for generating invoices for all services that are due for billing. It:

- Queries all active services with expiry dates on or before today
- Generates an invoice for each service using the BillingService
- Logs the execution results
- Implements retry mechanism (3 attempts with 60-second backoff)

**Key Features**:
- Implements `ShouldQueue` interface for background processing
- Automatic retry on failure (up to 3 times)
- Comprehensive logging for monitoring and debugging
- Error handling with graceful degradation

### 2. Laravel Scheduler Configuration

**Location**: `routes/console.php`

The scheduler is configured to dispatch the GenerateInvoicesJob daily at 00:00 WIB:

```php
Schedule::job(new GenerateInvoicesJob())
    ->dailyAt('00:00')
    ->timezone('Asia/Jakarta') // WIB timezone
    ->name('generate-invoices')
    ->withoutOverlapping()
    ->onSuccess(function () {
        \Log::info('Scheduled invoice generation completed successfully');
    })
    ->onFailure(function () {
        \Log::error('Scheduled invoice generation failed');
    });
```

**Configuration Details**:
- **Schedule**: Daily at 00:00 (midnight)
- **Timezone**: Asia/Jakarta (WIB)
- **Name**: generate-invoices
- **Overlap Prevention**: `withoutOverlapping()` ensures only one instance runs at a time
- **Success Callback**: Logs successful execution
- **Failure Callback**: Logs failed execution

### 3. BillingService Integration

The job uses the `BillingService::generateInvoicesForDueServices()` method which:

1. Queries all active services where `expiry_date <= today`
2. For each service:
   - Calculates invoice amount from package price
   - Sets invoice date to today
   - Sets due date to (invoice_date + billing_cycle_days)
   - Creates invoice record with status 'unpaid'
3. Returns collection of generated invoices

## Service Selection Criteria

A service is eligible for invoice generation if:

1. **Status is 'active'**: Only active services are billed
2. **Expiry date is today or in the past**: Services that are due or overdue

Services with the following statuses are **NOT** billed:
- `isolated`: Service is suspended due to non-payment
- `suspended`: Service is temporarily suspended
- `terminated`: Service has been terminated
- `pending`: Service is not yet activated
- `provisioning_failed`: Service provisioning failed

## Invoice Generation Details

For each eligible service, an invoice is created with:

- **service_id**: ID of the service being billed
- **tenant_id**: Tenant ID from the service (for multi-tenancy)
- **amount**: Package price from the service's package
- **status**: 'unpaid'
- **invoice_date**: Current date
- **due_date**: invoice_date + billing_cycle_days (default: 30 days)
- **payment_link**: null (will be generated by payment gateway integration)

## Running the Scheduler

### Production Environment

In production, the Laravel scheduler must be configured to run via cron:

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

This cron entry runs every minute and Laravel determines which scheduled tasks should run.

### Development/Testing

To test the scheduler manually:

```bash
# Run all scheduled tasks that are due
php artisan schedule:run

# List all scheduled tasks
php artisan schedule:list

# Run the job manually (for testing)
php artisan queue:work --once
```

To dispatch the job manually for testing:

```php
use App\Jobs\GenerateInvoicesJob;

GenerateInvoicesJob::dispatch();
```

## Monitoring and Logging

### Log Entries

The job creates the following log entries:

**On Start**:
```
[INFO] GenerateInvoicesJob started
```

**On Success**:
```
[INFO] GenerateInvoicesJob completed
{
    "invoices_generated": 5,
    "invoice_ids": [1, 2, 3, 4, 5]
}
```

**On Error**:
```
[ERROR] GenerateInvoicesJob failed
{
    "error": "Error message",
    "trace": "Stack trace..."
}
```

**On Final Failure** (after all retries):
```
[CRITICAL] GenerateInvoicesJob failed after all retries
{
    "error": "Error message",
    "trace": "Stack trace..."
}
```

### Monitoring Recommendations

1. **Monitor log files** for ERROR and CRITICAL entries
2. **Set up alerts** for failed job executions
3. **Track invoice generation counts** to detect anomalies
4. **Monitor queue worker status** to ensure jobs are processed
5. **Check failed_jobs table** regularly for permanently failed jobs

## Queue Configuration

The job uses the default queue configuration. Ensure:

1. **Queue driver is configured** (Redis recommended for production)
2. **Queue workers are running**:
   ```bash
   php artisan queue:work --tries=3 --timeout=90
   ```
3. **Supervisor is configured** to keep workers running (production)

### Supervisor Configuration Example

```ini
[program:isp-billing-queue-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path-to-project/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=3
redirect_stderr=true
stdout_logfile=/path-to-project/storage/logs/worker.log
stopwaitsecs=3600
```

## Error Handling

### Retry Mechanism

- **Attempts**: 3 tries
- **Backoff**: 60 seconds between retries
- **Behavior**: Exponential backoff with each retry

### Failure Scenarios

1. **Database Connection Error**: Job will retry up to 3 times
2. **Service Without Package**: Error logged, continues with other services
3. **Queue Worker Down**: Job remains in queue until worker is available
4. **Scheduler Not Running**: Job won't be dispatched (check cron configuration)

### Recovery

If the job fails after all retries:

1. Check the `failed_jobs` table for details
2. Review error logs for root cause
3. Fix the underlying issue
4. Retry the failed job:
   ```bash
   php artisan queue:retry <job-id>
   ```
   Or retry all failed jobs:
   ```bash
   php artisan queue:retry all
   ```

## Testing

### Unit Tests

**Location**: `tests/Unit/Jobs/GenerateInvoicesJobTest.php`

Tests cover:
- Job can be dispatched to queue
- Generates invoices for due services
- Respects service status (only active)
- Respects expiry dates (only due services)
- Logging behavior
- Retry configuration
- Error handling

### Feature Tests

**Location**: `tests/Feature/ScheduledInvoiceGenerationTest.php`

Tests cover:
- Scheduler dispatches the job
- End-to-end invoice generation workflow
- Multiple packages handling
- Correct invoice dates and amounts
- Tenant ID preservation
- Past expiry dates handling

### Running Tests

```bash
# Run all job tests
php artisan test --filter=GenerateInvoicesJobTest

# Run all scheduled invoice generation tests
php artisan test tests/Feature/ScheduledInvoiceGenerationTest.php

# Run all tests
php artisan test
```

## Configuration

### Billing Cycle

The billing cycle is configured in `config/billing.php`:

```php
return [
    'cycle_days' => env('BILLING_CYCLE_DAYS', 30),
];
```

To change the billing cycle, set the environment variable:

```env
BILLING_CYCLE_DAYS=30
```

### Timezone

The scheduler uses the `Asia/Jakarta` timezone (WIB). To change this, modify the scheduler configuration in `routes/console.php`.

## Troubleshooting

### Job Not Running

1. **Check cron is configured**:
   ```bash
   crontab -l
   ```

2. **Verify scheduler is working**:
   ```bash
   php artisan schedule:list
   ```

3. **Check queue workers are running**:
   ```bash
   ps aux | grep "queue:work"
   ```

### No Invoices Generated

1. **Check if there are eligible services**:
   ```sql
   SELECT * FROM services 
   WHERE status = 'active' 
   AND expiry_date <= CURDATE();
   ```

2. **Check logs** for errors:
   ```bash
   tail -f storage/logs/laravel.log
   ```

3. **Run job manually** to test:
   ```bash
   php artisan tinker
   >>> dispatch(new \App\Jobs\GenerateInvoicesJob());
   ```

### Duplicate Invoices

The current implementation generates a new invoice each time the job runs for eligible services. This is expected behavior as each billing cycle generates a new invoice. To prevent duplicates:

1. Ensure services' `expiry_date` is updated after payment
2. Implement additional logic to check for recent invoices if needed

## Future Enhancements

Potential improvements for future versions:

1. **Payment Link Generation**: Integrate with payment gateway to generate payment links
2. **Notification Queueing**: Queue email/WhatsApp notifications for generated invoices
3. **Duplicate Prevention**: Add logic to prevent duplicate invoices within the same billing period
4. **Batch Processing**: Process services in batches for better performance with large datasets
5. **Reporting**: Generate daily reports of invoice generation activity
6. **Alerting**: Send alerts to admins when invoice generation completes or fails

## Related Documentation

- [BillingService Documentation](./billing-service.md)
- [Laravel Scheduler Documentation](https://laravel.com/docs/12.x/scheduling)
- [Laravel Queues Documentation](https://laravel.com/docs/12.x/queues)
